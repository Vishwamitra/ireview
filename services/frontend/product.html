<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Review App - Products</title>
        <meta name="description" content="A website that reviews products">
        <link rel="stylesheet" href="css/all.css?v=1.0">
        <link rel="stylesheet" href="css/product.css?v=1.0">
        <script src="js/all.js"></script>
    </head>
    <body>
        <div id="page_product">
            <div class="loader"></div>
            <div class="product-information"></div>
            <div class="product-reviews"></div>
            <div class="product-review-add"></div>
        </div>
    </body>
    <script>

        /* --------------------------------      
        ------- Variables/Contants --------
        ----------------------------------- */

        var reviews = []

        /* ---------------------------      
        ------- Show contents --------
        ------------------------------ */

        const reviewHtmls = (input) => {
            var result = ''
            if (input.length == 0) return 'There are no reviews written yet. Below you can add a review.'

            // todo: sort on descending date
            input = input.sort((a, b) => (a.date < b.date) ? 1 : -1)

            input.forEach((review, i) => { 
                result += `<div class="review">
                    <div class="profile-picture" style="background-image: url(images/dummy-profile-picture.png)"> </div>
                    <div class="user"> 
                        <h3> ${review.author} </h3>
                        <h5 class="date"> ${getTime(review.date)} </h5> 
                    </div>
                    <h3 class='summary'> ${review.summary} </h3>
                    <h4 class='rating'> ${review.rating}/10 </h4>
                    <h4 class='description'> ${review.description} </h4>
                    <span class="button delete" onClick="deleteReview(${review.id})"> DELETE </span>
                </div>`
            })
            return result
        }

        const showProductInformation = (product) => {
            const productInformation = document.querySelector(".product-information")
            productInformation.innerHTML = `
                <div class="left" style="background-image: url(images/product-cover-1.png);"></div>
                <div class="right">
                    <div class="inner">
                        <h1 class='title'> ${product.name} </h1>
                        <h5 class="price"> Starting from $${product.price} </h5>
                        <div class='stars'> ${starsHtml(product.stars)} </div>
                        <h4 class='description'> ${product.description} </h4>
                    </div>
                </div>
            `
        }

        const showProductReviews = (input) => {
            const productReviews = document.querySelector(".product-reviews")
            productReviews.innerHTML = `
                <h1> Reviews </h1>
                <div class="reviews">
                    ${reviewHtmls(input ? input : reviews)}
                </div>
            `
        }

        const starSelectorHtml = (num) => {
            var result = ''
            Array.from(Array(num).keys()).forEach((star, j) => {
                result += `<option> ${j + 1} </option>`
            })
            return result
        }

        const initializeAddReview = () => {
            const productReviewAdd = document.querySelector(".product-review-add")
            productReviewAdd.innerHTML = `
                <h2> Add review </h2>
                <input type="text" class="add-review-user" placeholder="Your name"/>
                Rating <select class="add-review-rating">
                    ${starSelectorHtml(10)}
                </select>
                <textarea class="add-review-summary" placeholder="Short description"></textarea>
                <textarea class="add-review-description" placeholder="Enter review"></textarea>
                <span class="button add" onClick="addReview()"> ADD </span>
            `
        }

        /* -----------------          
        ------- API --------
        -------------------- */

        const fetchProduct = () => { // TODO: axios
            const result = { // todo: dummy data
                id: 1,
                name: "Apple Watch",
                stars: 5,
                price: 249,
                description: "Apple Watch is a wearable smartwatch that allows users to accomplish a variety of tasks, including making phone calls, sending text messages and reading email. ... In addition to using a Bluetooth connection, the watch can also connect with an iPhone if it is on the same Wi-Fi network.",
                reviews: []
            }

            // show components
            document.querySelector(".loader").remove()
            reviews = result.reviews
            showProductInformation(result)
            showProductReviews()
            initializeAddReview()
        }

        const addReview = (input) => { // TODO: axios
            reviews.push({
                id: Math.floor(Math.random() * 100), // todo: retrieve from backend
                date: Date.now(), // todo: retrieve from backend
                rating: parseInt(document.querySelector(".add-review-rating").value),
                author: document.querySelector(".add-review-user").value || "Anonymous",
                summary: document.querySelector(".add-review-summary").value,
                description: document.querySelector(".add-review-description").value
            })
            showProductReviews(reviews)
            initializeAddReview()
        }

        const deleteReview = (id) => { // TODO: axios
            reviews = reviews.filter(review => review.id != id)
            showProductReviews(reviews)
        }

        /* -----------------------      
        ------- On render --------
        -------------------------- */

        window.onload = () => {
            fetchProduct()
        }

    </script>
</html>