<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Review App - Products</title>
        <meta name="description" content="A website that reviews products">
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <link rel="stylesheet" href="css/all.css?v=1.0">
        <link rel="stylesheet" href="css/product.css?v=1.0">
        <script src="js/all.js"></script>
    </head>
    <body>

        <div id="page_product" class="loading">
            <div class="loader"></div>
            <div class="product-information"></div>
            <div class="product-reviews"></div>
            <div class="product-review-add"></div>
        </div>
    </body>
    <script>

        /* --------------------------------      
        ------- Variables/Contants --------
        ----------------------------------- */

        var reviews = []
        var productInfo = {}
        const NUMBER_OF_RATINGS = 10
        const DEFAULT_RATING = 6

        /* ---------------------------      
        ------- Show contents --------
        ------------------------------ */

        const reviewHtmls = (input) => {
            var result = ''
            if (input.length == 0) return `There are no reviews written yet. Below you can add a review about '${productInfo.ProductName}'.`
            input = input.sort((a, b) => (a.ReviewTime < b.ReviewTime) ? 1 : -1)

            input.forEach((review, i) => { 
                result += `<div class="review">
                    <div class="profile-picture" style="background-image: url(images/dummy-profile-picture.png)"> </div>
                    <div class="user"> 
                        <h3> ${review.Reviewer} </h3>
                        <h5 class="date"> ${getTime(review.ReviewTime)} </h5> 
                    </div>
                    <h3 class='summary'> ${review.ReviewSummary} </h3>
                    <h4 class='rating'> ${review.ReviewPriceQuality}/${NUMBER_OF_RATINGS} </h4>
                    <h4 class='description'> ${review.ReviewDescription} </h4>
                    <span class="button delete" onClick="deleteReview(${review.ReviewID})"> DELETE </span>
                </div>`
            })
            return result
        }

        const showProductInformation = (product) => {
            const productInformation = document.querySelector(".product-information")
            productInformation.innerHTML = `
                <div class="left" style="background-image: url(images/product-cover-${product.ProductID}.png);"></div>
                <div class="right">
                    <div class="inner">
                        <h1 class='title'> ${product.ProductName} </h1>
                        <h5 class="price"> Starting from $${product.ProductPrice} </h5>
                        <div class='stars'> ${starsHtml(product.AvgReview)} </div>
                        <h4 class='description'> ${product.ProductDescription} </h4>
                    </div>
                </div>
            `
        }

        const showProductReviews = (input) => {
            const productReviews = document.querySelector(".product-reviews")
            productReviews.innerHTML = `
                <h1> Reviews </h1>
                <div class="reviews">
                    ${reviewHtmls(input ? input : reviews)}
                </div>
            `
        }

        const starSelectorHtml = () => {
            var result = ''
            Array.from(Array(NUMBER_OF_RATINGS).keys()).forEach((star, j) => {
                var rating = j + 1
                result += `<option ${rating == DEFAULT_RATING ? 'selected="selected"' : ''}> ${rating} </option>`
            })
            return result
        }

        const initializeAddReview = () => {
            const productReviewAdd = document.querySelector(".product-review-add")
            productReviewAdd.innerHTML = `
                <h2> Add review </h2>
                <input type="text" class="add-review-user" placeholder="Your name"/>
                Rating <select class="add-review-rating">
                    ${starSelectorHtml()}
                </select>
                <textarea class="add-review-summary" placeholder="Short description"></textarea>
                <textarea class="add-review-description" placeholder="Enter review"></textarea>
                <span class="button add" onClick="addReview()"> ADD </span>
            `
        }

        /* -----------------          
        ------- API --------
        -------------------- */

        const fetchProduct = () => { 
            const id = window.location.href.split("=").slice(-1)
            axios.get(`http://localhost:5000/product/${id}`).then(response => {
                const { data } = response
                productInfo = data
                reviews = data.reviews

                // show components
                showProductInformation(data)
                showProductReviews()
                initializeAddReview()
                document.querySelector(".loader").remove()

            }).catch(error => console.error(error))
        }

        const addReview = (input) => { 
            axios.post(`http://localhost:5000/review`, {
                ProductID: productInfo.ProductID,
                ReviewPriceQuality: parseInt(document.querySelector(".add-review-rating").value),
                Reviewer: document.querySelector(".add-review-user").value || "Anonymous",
                ReviewSummary: document.querySelector(".add-review-summary").value,
                ReviewDescription: document.querySelector(".add-review-description").value
            }).then(response => { 
                reviews.push(response.data) 
                showProductReviews()
                initializeAddReview()
            }).catch(error => console.error(error))
        }

        const deleteReview = (id) => { 
            axios.get(`http://localhost:5000/review/delete/${id}`).then(response => { 
                reviews = reviews.filter(review => review.ReviewID != id)
                showProductReviews()
            }).catch(error => console.error(error))
        }

        /* -----------------------      
        ------- On render --------
        -------------------------- */

        window.onload = () => {
            fetchProduct()
        }

    </script>
</html>